<div class="mt-10 w-[90%] m-auto flex flex-col gap-5">
    <h2 class="text-xl font-bold">Favorites</h2>
    <div id="favorites-container" class="flex flex-col gap-4">
        <!-- Favorite recipes will be added here dynamically -->
    </div>
</div>

<script>
    async function fetchFavorites() {
        const user = auth.currentUser;
        if (!user) {
            console.log('User is not authenticated.');
            document.getElementById('favorites-container').innerHTML = '<p>You need to be signed in to see your favorites.</p>';
            return;
        }

        const favoritesRef = db.collection('users').doc(user.uid).collection('favorites');
        try {
            const snapshot = await favoritesRef.get();
            const container = document.getElementById('favorites-container');
            if (snapshot.empty) {
                console.log('No favorite recipes found.');
                container.innerHTML = '<p>No favorites found.</p>';
                return;
            }

            container.innerHTML = ''; // Clear the container before adding new content
            snapshot.forEach(doc => {
                const data = doc.data();
                const { label, image, calories, ingredients, healthLabel } = data;
                const ingredientsCount = ingredients ? ingredients.length : 0;
                const healthLabels = healthLabel ? healthLabel : 'No Label'; 
                const calorieText = calories ? `${calories} Cal` : 'No Calories';

                const cardHTML = `
                    <div class="flex rounded-xl bg-fcp1 p-3 gap-2 w-full">
                        <div class="w-[35%]">
                            <img class="rounded-xl object-cover h-full" src="${image}" alt="${label}">
                        </div>
                        <div class="flex flex-col gap-1 w-[75%]">
                            <div class="flex justify-between items-center gap-4 w-full">
                                <p class="font-medium w-[75%]">${label}</p>
                                <button class="remove-favorite" data-id="${doc.id}">
                                    <img class="w-fit" src="Public/img/favorite.svg" alt="">
                                </button>
                            </div>
                            <div class="flex justify-between text-sm font-medium">
                                <p>${calorieText}</p>
                                <div class="flex gap-1">
                                    <p>${ingredientsCount} Ingredients</p>
                                </div>
                            </div>
                            <div>
                                <button class="text-fcp1 bg-fcp2 rounded-2xl py-2 px-3 text-sm font-semibold">${healthLabels}</button>
                            </div>
                        </div>
                    </div>
                `;

                container.innerHTML += cardHTML;
            });

            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-favorite').forEach(button => {
                button.addEventListener('click', async function() {
                    const recipeId = this.getAttribute('data-id');
                    await removeFavorite(recipeId);
                });
            });

        } catch (error) {
            console.error('Error fetching favorite recipes:', error);
        }
    }

    async function removeFavorite(recipeId) {
        const user = auth.currentUser;
        if (!user) {
            console.log('User is not authenticated.');
            return;
        }

        const favoritesRef = db.collection('users').doc(user.uid).collection('favorites');
        try {
            await favoritesRef.doc(recipeId).delete();
            console.log('Recipe removed from favorites');
            // Refresh the favorites list
            fetchFavorites();
        } catch (error) {
            console.error('Error removing recipe from favorites:', error);
        }
    }

    // Check if user is signed in before fetching favorites
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log('User is signed in:', user);
            fetchFavorites();
        } else {
            console.log('No user is signed in.');
            document.getElementById('favorites-container').innerHTML = '<p>You need to be signed in to see your favorites.</p>';
        }
    });
</script>
